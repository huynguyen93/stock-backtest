<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div>
    <div class="p-5">
        <div class="row">
            <div class="col-6">
                <canvas id="prices"></canvas>
            </div>
            <div class="col-6">
                <canvas id="monthlyAmountChart"></canvas>
            </div>
            <div class="col-6">
                <canvas id="profitChart"></canvas>
            </div>
            <div class="col-6">
                <canvas id="cash"></canvas>
            </div>
        </div>
        <hr>

        <div class="row">
            <div class="col-md-6 col-lg-3">
                <table class="table">
                    <tbody>
                    <tr>
                        <th>Current stock value</th>
                        <td id="shares-value"></td>
                    </tr>
                    <tr>
                        <th>Current cash</th>
                        <td id="current-cash"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
<script>
  fetch('/prices.json')
    .then((response) => response.json())
    .then((pricesByMonth) => {
      const startDate = '2007-01-01';
      const monthlyCashIn = 10000000;
      let availableCash = 0;
      let nbShares = 0;
      let originalShareValue = 0;
      let currentSharesValue = 0;
      let highestSharesValue = 0;

      const labels = [];
      const monthlyInvests = [];
      const profits = [];
      const highestValues = [];
      const initialValues = [];
      const currentValues = [];
      const cash = [];
      const prices = [];

      pricesByMonth.forEach(({date, price: thisMonthPrice}) => {
        if (date < startDate) {
          return;
        }

        currentSharesValue = nbShares * thisMonthPrice;
        let amountToBuyThisMonth = monthlyCashIn;

        if (currentSharesValue > originalShareValue) {
          amountToBuyThisMonth = (originalShareValue - currentSharesValue) / 10;
        }

        if (currentSharesValue < originalShareValue) {
          const diffPercent = originalShareValue/currentSharesValue - 1;
          amountToBuyThisMonth = monthlyCashIn + (diffPercent * monthlyCashIn) *2;
        }

        if (amountToBuyThisMonth > 0) {
          originalShareValue += amountToBuyThisMonth;
        }

        availableCash -= amountToBuyThisMonth;
        nbShares += amountToBuyThisMonth / thisMonthPrice;
        currentSharesValue = nbShares * thisMonthPrice;

        labels.push(date + ' - ' + thisMonthPrice);
        monthlyInvests.push(amountToBuyThisMonth);
        profits.push((currentSharesValue) / originalShareValue * 100 - 100);

        highestSharesValue = Math.max(highestSharesValue, currentSharesValue);
        highestValues.push(highestSharesValue);

        initialValues.push(originalShareValue);
        currentValues.push(currentSharesValue);
        cash.push(availableCash);
        prices.push(thisMonthPrice);
      });

      document.getElementById('shares-value').innerHTML = format(currentSharesValue);
      document.getElementById('current-cash').innerHTML = format(availableCash);

      new Chart(document.getElementById('profitChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'initialValues',
              data: initialValues,
              borderWidth: 1
            },
            {
              label: 'currentValues',
              data: currentValues,
              borderWidth: 1
            },
          ]
        },
      });

      new Chart(document.getElementById('monthlyAmountChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'monthlyInvestment',
              data: monthlyInvests,
              borderWidth: 1
            },
          ]
        },
      });

      new Chart(document.getElementById('cash'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'cash %',
              data: cash,
              borderWidth: 1
            },
          ]
        },
      });

      new Chart(document.getElementById('prices'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'prices',
              data: prices,
              borderWidth: 1
            },
          ]
        },
      });
    });

  const formatter = Intl.NumberFormat();

  function format(number) {
    return formatter.format(number);
  }
</script>
</body>
</html>
