<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div>
    <div class="container pb-5">
        <div class="row">
            <div class="col-12">
                <canvas id="monthlyAmountChart"></canvas>
            </div>
            <div class="col-12">
                <canvas id="profitChart"></canvas>
            </div>
            <div class="col-12">
                <canvas id="profitsChart"></canvas>
            </div>
            <div class="col-12">
                <canvas id="cash"></canvas>
            </div>
        </div>

        <div>
            Total investment:
            <b id="total-investment"></b>
        </div>

        <div>
            Current stock value:
            <b id="shares-value"></b>
        </div>

        <div>
            Current cash:
            <b id="current-cash"></b>
        </div>

        <div>
            Profit percent:
            <b id="profit-percent"></b>%
        </div>
    </div>

</div>
<script>
  fetch('/prices.json')
    .then((response) => response.json())
    .then((pricesByMonth) => {
      const monthlyCashIn = 10000000;
      let totalInvested = 0;
      let availableCash = 0;
      let nbShares = 0;
      let initialSharesValue = 0;
      let currentSharesValue = 0;
      let highestSharesValue = 0;

      const labels = [];
      const monthlyInvests = [];
      const profits = [];
      const highestValues = [];
      const initialValues = [];
      const currentValues = [];
      const cash = [];

      pricesByMonth.forEach(({date, price: thisMonthPrice}) => {
        totalInvested += monthlyCashIn;
        availableCash += monthlyCashIn;
        currentSharesValue = nbShares * thisMonthPrice;
        let amountToBuyThisMonth = monthlyCashIn;

        const diffPercent = currentSharesValue / initialSharesValue - 1;
        if (diffPercent > 0) {
          amountToBuyThisMonth = monthlyCashIn - (diffPercent * monthlyCashIn);
        } else if (diffPercent < 0) {
          amountToBuyThisMonth = monthlyCashIn - (diffPercent * monthlyCashIn * 2);
        }

        availableCash -= amountToBuyThisMonth;
        nbShares += amountToBuyThisMonth / thisMonthPrice;
        initialSharesValue += amountToBuyThisMonth;
        currentSharesValue = nbShares * thisMonthPrice;

        labels.push(date + ' - ' + thisMonthPrice);
        monthlyInvests.push(amountToBuyThisMonth);
        profits.push((currentSharesValue) / initialSharesValue * 100 - 100);

        highestSharesValue = Math.max(highestSharesValue, currentSharesValue);
        highestValues.push(highestSharesValue);

        initialValues.push(initialSharesValue);
        currentValues.push(currentSharesValue);
        cash.push(availableCash);
      });

      document.getElementById('total-investment').innerHTML = format(initialSharesValue);
      document.getElementById('shares-value').innerHTML = format(currentSharesValue);
      document.getElementById('profit-percent').innerHTML = format((currentSharesValue + availableCash) / initialSharesValue * 100 - 100);
      document.getElementById('current-cash').innerHTML = format(availableCash);

      new Chart(document.getElementById('profitChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'initialValues',
              data: initialValues,
              borderWidth: 1
            },
            {
              label: 'currentValues',
              data: currentValues,
              borderWidth: 1
            },
            {
              label: 'highestValues',
              data: highestValues,
              borderWidth: 1
            },
          ]
        },
      });

      new Chart(document.getElementById('monthlyAmountChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'monthlyInvestment',
              data: monthlyInvests,
              borderWidth: 1
            },
          ]
        },
      });

      new Chart(document.getElementById('profitsChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'profit %',
              data: profits,
              borderWidth: 1
            },
          ]
        },
      });

      new Chart(document.getElementById('cash'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'cash %',
              data: cash,
              borderWidth: 1
            },
          ]
        },
      });
    });

  const formatter = Intl.NumberFormat();

  function format(number) {
    return formatter.format(number);
  }
</script>
</body>
</html>
